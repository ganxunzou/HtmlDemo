<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MediaCapture and Streams API</title>
    <meta name="viewport" content="width=device-width" />
    <script src="../js/jquery-2.1.0.js"></script>
    <!-- <link rel="stylesheet" href="main.css" /> -->
  </head>
  <body>
    <header>
      <h1>MediaCapture, MediaRecorder and Streams API</h1>
    </header>
    <main>
      <p>
        Lorem ipsum dolor sit amet, consectetur adipisicing elit. Impedit
        molestiae itaque facere totam saepe tempore esse temporibus, quae
        reprehenderit aliquid iusto ea laborum, iure eligendi odio
        exercitationem sapiente illum quos.
      </p>
      <p>
        <button id="btnStart">START RECORDING</button><br />
        <button id="btnStop">STOP RECORDING</button>
        <button onclick="sendAA()">SEND</button>
      </p>

      <video autoplay></video>

      <video id="vid2" controls></video>

      <!-- could save to canvas and do image manipulation and saving too -->
    </main>
    <script>
      let constraintObj = {
        audio: true,
        video: {
          facingMode: "user",
          width: { min: 640, ideal: 1280, max: 1920 },
          height: { min: 480, ideal: 720, max: 1080 },
        },
      };
      navigator.mediaDevices.getUserMedia = function (constraintObj) {
        let getUserMedia =
          navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
        if (!getUserMedia) {
          return Promise.reject(
            new Error("getUserMedia is not implemented in this browser")
          );
        }
        return new Promise(function (resolve, reject) {
          getUserMedia.call(navigator, constraintObj, resolve, reject);
        });
      };

      navigator.mediaDevices
        .enumerateDevices()
        .then((devices) => {
          devices.forEach((device) => {
            console.log(device.kind.toUpperCase(), device.label);
            //, device.deviceId
          });
        })
        .catch((err) => {
          console.log(err.name, err.message);
        });

      navigator.mediaDevices
        .getUserMedia(constraintObj)
        .then(function (mediaStreamObj) {
          //connect the media stream to the first video element
          console.log("mediaStreamObj", mediaStreamObj);
          let video = document.querySelector("video");
          if ("srcObject" in video) {
            video.srcObject = mediaStreamObj;
          } else {
            //old version
            video.src = window.URL.createObjectURL(mediaStreamObj);
          }

          video.onloadedmetadata = function (ev) {
            //show in the video element what is being captured by the webcam
            video.play();
          };

          //add listeners for saving video/audio
          let start = document.getElementById("btnStart");
          let stop = document.getElementById("btnStop");
          let vidSave = document.getElementById("vid2");
          var options = {
            mimeType: "video/mp4;  codecs='av01.0.00M.08, opus'",
          };
          let mediaRecorder = new MediaRecorder(mediaStreamObj);
          let chunks = [];

          start.addEventListener("click", (ev) => {
            mediaRecorder.start();
            console.log(mediaRecorder.state);
            console.log(MediaRecorder.mimeType);
          });
          stop.addEventListener("click", (ev) => {
            mediaRecorder.stop();
            console.log(mediaRecorder.state);
          });

          mediaRecorder.ondataavailable = function (ev) {
            console.log("ev.data", ev.data);
            chunks.push(ev.data);
          };

          mediaRecorder.onstop = (ev) => {
            let blob = new Blob(chunks, { type: "video/mp4;" });
            chunks = [];
            let videoURL = window.URL.createObjectURL(blob);
            vidSave.src = videoURL;

            saveBlob(blob);
            // console.log('blob', blob)
            // window.ab = blob;
            // const a = document.createElement("a");
            // a.download = "xxx.mp4";
            // a.href = videoURL;
            // a.click();

            // window.jsBridge.saveBytes(blob.arrayBuffer());

            // blob.arrayBuffer().then(buffer => {indow.jsBridge.saveBytes(buffer)});
          };
        })
        .catch(function (err) {
          console.log(err.name, err.message);
        });


        function saveBlob(blob) {
          let reader = new FileReader()
          reader.onload = function() {
              if (reader.readyState == 2) {
                console.log('reader.result', reader.result)
                  // var buffer = new Buffer(reader.result)
                  window.jsBridge.saveBytes(new Uint8Array(reader.result));
              }
          }
          reader.readAsArrayBuffer(blob)
        }

      /*********************************
          getUserMedia returns a Promise
          resolve - returns a MediaStream Object
          reject returns one of the following errors
          AbortError - generic unknown cause
          NotAllowedError (SecurityError) - user rejected permissions
          NotFoundError - missing media track
          NotReadableError - user permissions given but hardware/OS error
          OverconstrainedError - constraint video settings preventing
          TypeError - audio: false, video: false
          *********************************/
      function sendAA() {
        // var formData = new FormData();
        // formData.append("username", "Groucho");
        // formData.append("accountnum", 123456); //数字123456会被立即转换成字符串 "123456"

        // var request = new XMLHttpRequest();
        // request.open("POST", "custom://foo.com/submitform.php");
        // request.send(formData);

        var fd = new FormData();
        fd.append("CustomField", "This is some extra data");
        $.ajax({
          url: "custom://stash.php",
          type: "get",
          data: fd,
          processData: false,  // 不处理数据
          contentType: false   // 不设置内容类型
        });
      }
    </script>
  </body>
</html>
